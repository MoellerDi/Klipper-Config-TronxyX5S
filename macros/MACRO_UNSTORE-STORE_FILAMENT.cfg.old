[gcode_macro STORE_FILAMENT]
description: Move active extruder to store-position
default_parameter_FORCE: 0
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set filament_state = svv.filament_loaded %}

  {% if FORCE|int == 1 %}
    {% set filament_state = 1 %}
  {% endif %}

  {% if filament_state|int == 1 %}
    M118 STORE_FILAMENT: Unload filament
    M400 ;Finish Moves
    ;M117 filament to storage position
    G92 E0          ;zero extruded length
    G1 E-5 F3000    ;stage 1 of 3 (retract to -5)
    G92 E0          ;zero extruded length
    G1 E2 F3000     ;stage 2 of 3 (move forward from -5 to -3)
    G92 E0          ;zero extruded length
    G1 E-747 F3000  ;stage 3 of 3 (move to storage position E-750)
    G92 E0          ;zero extruded length
    M400 ;Finish Moves
    SAVE_VARIABLE VARIABLE=filament_loaded VALUE=0
  {% else %}
    M118 STORE_FILAMENT: Filament already unloaded (FORCE={FORCE})
  {% endif %}

[gcode_macro UNSTORE_FILAMENT]
description: Move active extruder to unstore-position
default_parameter_FORCE: 0
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set filament_state = svv.filament_loaded %}

  {% if FORCE|int == 1 %}
    {% set filament_state = 0 %}
  {% endif %}

  {% if (filament_state|int == 0) %}
    M118 UNSTORE_FILAMENT: Load filament
    M400 ;Finish Moves
    ;M117 E from storage position
    G92 E0         ;zero extruded length
    G1 F3000 E750 ;return from storage position
    G92 E0         ;zero extruded length
    M400 ;Finish Moves
    SAVE_VARIABLE VARIABLE=filament_loaded VALUE=1
  {% else %}
    M118 STORE_FILAMENT: Filament already loaded (FORCE={FORCE})
  {% endif %}

