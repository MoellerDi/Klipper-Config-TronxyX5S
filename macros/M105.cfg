[gcode_macro M105]
description: Replacing M105 and Sync LED with Temperature
rename_existing: M105.1
gcode:  

   #M118 M105_debug: printer.extruder.temperature: {printer.extruder.temperature}
   #M118 M105_debug: printer.extruder.target: {printer.extruder.target}

   #if the extruder is off
   {% if printer.extruder.target == 0 %}
      #Set the LED to red if the extruder is off but is still hot, otherwise 
      # set the color to green
      {% if printer.extruder.temperature > printer.configfile.config["heater_fan extruder_fan"]["heater_temp"]|float %}
         M118 M105_debug: extruder is cooling down
         SET_LED LED=caselight RED=0.4 GREEN=0 BLUE=0 TRANSMIT=1
      {% else %}
         #M118 M105_debug: extruder is cold
  		 SET_LED LED=fysetc_mini12864 RED=0 GREEN=0.1 BLUE=0 INDEX=1 TRANSMIT=0
  		 SET_LED LED=fysetc_mini12864 RED=0 GREEN=0.1 BLUE=0 INDEX=2 TRANSMIT=1
         SET_LED LED=caselight RED=0 GREEN=0.4 BLUE=0 TRANSMIT=1
      {% endif %}     
   {% else %}
         #if the extruder temp is at target temperature 
         {% if printer.extruder.temperature >= printer.extruder.target - 2.0 %}
            #M118 M105_debug: extruder is at target temperature
            SET_LED LED=caselight RED=0.4 GREEN=0.4 BLUE=0.4 TRANSMIT=1
         #if the extruder is still heating
         {% else %}
            M118 M105_debug: extruder is heating up
            {% set scaler = printer.extruder.temperature|float / printer.extruder.target|float %}
  			SET_LED LED=fysetc_mini12864 RED=0.1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
  			SET_LED LED=fysetc_mini12864 RED=0.1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=1
            SET_LED LED=caselight RED={ scaler|float * 1 } GREEN=0 BLUE=0 TRANSMIT=1
         {% endif %}  
   {% endif %}
   M105.1 # call original M105